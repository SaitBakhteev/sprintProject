name: Django CI/CD

on: [push]

jobs:
  test:
    runs-on: ubuntu-22.04
    env:
      SECRET_KEY: test-key
      FSTR_DB_HOST: localhost
      FSTR_DB_PORT: 5432
      FSTR_DB_NAME: test_db
      FSTR_DB_LOGIN: postgres
      FSTR_DB_PASS: postgres
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U postgres && echo "PostgreSQL is ready" && exit 0
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL failed to start" && exit 1
      - name: Run tests
        run: python manage.py test

  build:
    runs-on: ubuntu-22.04
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t sprint-img .

  deploy:
    runs-on: ubuntu-22.04
    needs: build
    env:
      HOST: ${{ secrets.VPS_HOST }}
      USER: ${{ secrets.VPS_USER }}
      KEY: ${{ secrets.SSH_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to VPS
        run: |
          echo "$KEY" > private_key
          chmod 600 private_key
          scp -o StrictHostKeyChecking=no -i private_key docker compose.yml $USER@$HOST:~/sprintProject/
          ssh -o StrictHostKeyChecking=no -i private_key $USER@$HOST "cd ~/sprintProject && docker compose down && docker compose up -d"